--Product Profitability Analysis
SELECT
	product_name,
	sum (sales) AS total_sales,
	sum (profit) AS total_profit,
	round(sum (profit) / sum (sales), 3) AS profit_margin
FROM
	superstore_dataset
GROUP BY
		product_name
HAVING
	sum (profit) < 0
ORDER BY
	total_sales DESC;

--Category & Sub-category Performance
SELECT
	category,
	subcategory,
	sum (sales) AS total_sales,
	sum (profit) AS total_profit,
	round (sum (profit) * 100.0 / sum (sales), 3) AS profit_margin
FROM
	superstore_dataset
GROUP BY
	category,
	subcategory
ORDER BY
	total_sales DESC

--Discount Impact on Profit
WITH base AS (
	SELECT
		CAST(replace (discount,',', '.') AS REAL) AS discount_value,
		sales, 
		profit
	FROM
		superstore_dataset
),
discount_binning AS (
	SELECT
		CASE
			WHEN discount_value = 0 THEN 'No discount'
			WHEN discount_value > 0 AND discount_value <= 0.2 THEN 'Low discound'
			WHEN discount_value > 0.2 AND discount_value <= 0.5 THEN 'Medium discount'
			WHEN discount_value > 0.5 THEN 'High discount'
			ELSE 'Unknown' 
		END AS category_discount,
		sales,
		profit
	FROM 
		base
)
SELECT
	category_discount,
	sum (sales) AS total_sales,
	sum (profit) AS total_profit,
	round(sum (profit) *100.0 / sum(sales), 3) AS profit_margin
FROM
	discount_binning
GROUP BY
	category_discount
ORDER BY
	category_discount
	
--Customer Segmentantation
WITH customer_summary AS (
	SELECT
		customer,
		sum(sales) AS total_sales,
		count (order_id) AS frequency_order
	FROM
		superstore_dataset
	GROUP BY
		customer 
),
average_frequency AS (
	SELECT
		avg(frequency_order) AS AVG_frequency_order
	FROM
		customer_summary
),
customer_segmentation AS (
	SELECT
		cs.customer,
		cs.total_sales,
		cs.frequency_order,
		CASE
			WHEN cs.frequency_order < af.AVG_frequency_order THEN 'Low value'
			WHEN cs.frequency_order BETWEEN af.AVG_frequency_order AND af.AVG_frequency_order * 1.5  THEN 'Medium value'
			WHEN cs.frequency_order > af.AVG_frequency_order * 1.5 THEN 'High value'
			ELSE 'Unknown' 
		END AS customer_segment
	FROM customer_summary cs
	CROSS JOIN average_frequency af
)
SELECT
	*
FROM
	customer_segmentation
ORDER BY
	total_sales DESC;

 --Regional Performance Analysis
WITH region_summary AS (
	SELECT
		region, country, state, city,
		sum (sales) AS total_sales,
		sum (profit) AS total_profit
	FROM
		superstore_dataset
	GROUP BY
		region, country, state, city
),
best_region AS (
	SELECT
		*,
		row_number () OVER(PARTITION BY region ORDER BY total_profit DESC) AS rn
	FROM
		region_summary
) 
SELECT
	region, country, state, city,
	total_sales,
	total_profit,
	round(total_profit / nullif(total_sales, 0), 3) AS profit_margin
FROM
	best_region
WHERE rn = 1
ORDER BY
	total_sales DESC

--Time Series Sales Trend Analysis
WITH sales_month AS (
SELECT
	substr (order_date, 7, 4) || '-' || substr (order_date, 4, 2) AS month,
	sum (sales) AS total_sales,
	sum (profit) AS total_profit
FROM
	superstore_dataset
GROUP BY
	month
),
sales_previous AS (
	SELECT
		*,
		lag(total_sales) OVER (ORDER BY month) AS previous_sales
	FROM 
		sales_month
		)
SELECT
	month,
	total_sales,
	total_profit,
	round((total_sales - previous_sales )* 100.0 / 
	nullif(previous_sales, 0), 3) AS sales_growth,
	CASE
		WHEN previous_sales is NULL THEN 'first Trend'
		WHEN total_sales < previous_sales THEN 'Downward Trend'
		WHEN total_sales > previous_sales THEN 'Upward Trend'
		ELSE 'Stable'
	END AS trend_segment	
FROM
	sales_previous
ORDER BY
	month;

